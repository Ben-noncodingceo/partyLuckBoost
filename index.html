<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´¾å¯¹æŠ½å¥–ç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: background 0.5s ease;
            overflow-x: hidden;
        }

        /* ä¸»é¢˜èƒŒæ™¯æ ·å¼ */
        body.theme-christmas {
            background: linear-gradient(135deg, #c94b4b 0%, #4b134f 100%);
        }

        body.theme-newyear {
            background: linear-gradient(135deg, #ffd700 0%, #ff6b6b 100%);
        }

        body.theme-birthday {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        }

        body.theme-corporate {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        }

        body.theme-spring {
            background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* åå•ç®¡ç†é¡µé¢ */
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #764ba2;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .participant-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s ease;
        }

        .participant-item:hover {
            background: #f8f9fa;
        }

        .participant-item.duplicate {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .participant-name {
            flex: 1;
            font-size: 16px;
        }

        .participant-actions button {
            margin-left: 5px;
            padding: 5px 15px;
            font-size: 14px;
        }

        .add-participant {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .add-participant input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }

        .warning-badge {
            background: #ffc107;
            color: #000;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }

        /* æŠ½å¥–é…ç½®é¡µé¢ */
        .config-section {
            margin-bottom: 30px;
        }

        .config-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .round-config {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }

        .round-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .round-header h4 {
            color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        /* æŠ½å¥–åŠ¨ç”»é¡µé¢ */
        .lottery-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .lottery-title {
            color: white;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .name-display {
            background: white;
            border-radius: 20px;
            padding: 60px 40px;
            margin: 40px auto;
            max-width: 800px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .rolling-names {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            min-height: 120px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .rolling-name {
            animation: rollIn 0.3s ease;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        @keyframes rollIn {
            from {
                transform: translateY(-50px) scale(0.5);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .lottery-button {
            padding: 25px 80px;
            font-size: 2em;
            border-radius: 50px;
            border: none;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(245, 87, 108, 0.4);
            font-weight: bold;
            margin-top: 40px;
        }

        .lottery-button:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(245, 87, 108, 0.6);
        }

        .lottery-button.active {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            box-shadow: 0 10px 30px rgba(86, 171, 47, 0.4);
        }

        .lottery-info {
            color: white;
            font-size: 1.2em;
            margin-top: 20px;
        }

        /* ç»“æœé¡µé¢ */
        .results-container {
            text-align: center;
        }

        .congrats {
            color: white;
            font-size: 3em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .winners-display {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin: 20px 0;
        }

        .round-results {
            margin-bottom: 40px;
        }

        .round-results h3 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .winner-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .winner-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            font-size: 1.3em;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: popIn 0.5s ease;
        }

        @keyframes popIn {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .action-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        /* ä¸»é¢˜é€‰æ‹©å™¨ */
        .theme-selector {
            margin-bottom: 20px;
        }

        .theme-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .rolling-names {
                font-size: 2em;
            }

            .lottery-button {
                padding: 20px 50px;
                font-size: 1.5em;
            }

            .winner-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons button {
                width: 100%;
            }
        }

        /* è¿›åº¦æŒ‡ç¤ºå™¨ */
        .progress-indicator {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .progress-step {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            color: white;
            font-weight: bold;
        }

        .progress-step.active {
            background: white;
            color: #667eea;
        }

        .progress-step.completed {
            background: rgba(86, 171, 47, 0.8);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
        <div class="progress-indicator">
            <div class="progress-step" data-step="1">1. åå•ç®¡ç†</div>
            <div class="progress-step" data-step="2">2. æŠ½å¥–é…ç½®</div>
            <div class="progress-step" data-step="3">3. å¼€å§‹æŠ½å¥–</div>
            <div class="progress-step" data-step="4">4. æŸ¥çœ‹ç»“æœ</div>
        </div>

        <!-- ç¬¬ä¸€é¡µï¼šåå•ç®¡ç† -->
        <div id="page1" class="page active">
            <div class="header">
                <h1>ğŸ‰ æ´¾å¯¹æŠ½å¥–ç³»ç»Ÿ</h1>
                <p>æ­¥éª¤ 1ï¼šç®¡ç†å‚ä¸è€…åå•</p>
            </div>

            <div class="card">
                <!-- ä¸»é¢˜é€‰æ‹© -->
                <div class="theme-selector">
                    <label for="themeSelect"><strong>é€‰æ‹©æ´»åŠ¨ä¸»é¢˜ï¼š</strong></label>
                    <select id="themeSelect">
                        <option value="default">é»˜è®¤ä¸»é¢˜</option>
                        <option value="christmas">åœ£è¯èŠ‚</option>
                        <option value="newyear">æ–°å¹´</option>
                        <option value="birthday">ç”Ÿæ—¥æ´¾å¯¹</option>
                        <option value="corporate">å…¬å¸å¹´ä¼š</option>
                        <option value="spring">æ˜¥èŠ‚</option>
                    </select>
                </div>

                <h2>ä¸Šä¼ å‚ä¸è€…åå•</h2>
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="fileInput" accept=".xlsx,.xls">
                    <div>
                        <p style="font-size: 3em; margin-bottom: 10px;">ğŸ“</p>
                        <p style="font-size: 1.2em; color: #667eea; font-weight: bold;">ç‚¹å‡»ä¸Šä¼  Excel æ–‡ä»¶</p>
                        <p style="color: #6c757d; margin-top: 10px;">æˆ–è€…æ‰‹åŠ¨æ·»åŠ å‚ä¸è€…</p>
                    </div>
                </div>

                <div class="add-participant">
                    <input type="text" id="newParticipant" placeholder="è¾“å…¥å‚ä¸è€…å§“å">
                    <button class="btn btn-success" id="addBtn">æ·»åŠ </button>
                </div>

                <div class="participant-list" id="participantList"></div>

                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="totalCount">0</div>
                        <div class="stat-label">æ€»äººæ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="duplicateCount">0</div>
                        <div class="stat-label">é‡åæ•°</div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="nextToConfig" disabled>ä¸‹ä¸€æ­¥ï¼šé…ç½®æŠ½å¥–</button>
                </div>
            </div>
        </div>

        <!-- ç¬¬äºŒé¡µï¼šæŠ½å¥–é…ç½® -->
        <div id="page2" class="page">
            <div class="header">
                <h1>ğŸ¯ æŠ½å¥–é…ç½®</h1>
                <p>æ­¥éª¤ 2ï¼šè®¾ç½®æŠ½å¥–è§„åˆ™</p>
            </div>

            <div class="card">
                <div class="config-section">
                    <h3>åŸºæœ¬è®¾ç½®</h3>
                    <div class="form-group">
                        <label for="totalRounds">æ€»å…±æŠ½å¥–æ¬¡æ•°ï¼š</label>
                        <input type="number" id="totalRounds" min="1" max="10" value="3">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="allowRepeat">
                        <label for="allowRepeat">å…è®¸ä¸­å¥–è€…å‚åŠ åç»­æŠ½å¥–</label>
                    </div>
                </div>

                <div class="config-section">
                    <h3>æŠ½å¥–è½®æ¬¡è®¾ç½®</h3>
                    <div id="roundsConfig"></div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" id="backToList">ä¸Šä¸€æ­¥</button>
                    <button class="btn btn-primary" id="startLottery">å¼€å§‹æŠ½å¥–</button>
                </div>
            </div>
        </div>

        <!-- ç¬¬ä¸‰é¡µï¼šæŠ½å¥–åŠ¨ç”» -->
        <div id="page3" class="page">
            <div class="lottery-screen">
                <h1 class="lottery-title" id="currentRoundTitle">ç¬¬ 1 è½®æŠ½å¥–</h1>

                <div class="name-display">
                    <div class="rolling-names" id="rollingNames">
                        <div>å‡†å¤‡å¼€å§‹...</div>
                    </div>
                </div>

                <button class="lottery-button" id="lotteryBtn">å¼€å§‹</button>

                <div class="lottery-info" id="lotteryInfo">
                    <p>æœ¬è½®å¥–é¡¹ï¼š<span id="currentPrizeName">-</span></p>
                    <p>æŠ½å–äººæ•°ï¼š<span id="currentPrizeCount">-</span></p>
                </div>
            </div>
        </div>

        <!-- ç¬¬å››é¡µï¼šç»“æœå±•ç¤º -->
        <div id="page4" class="page">
            <div class="results-container">
                <h1 class="congrats">ğŸŠ æ­å–œè·å¥–ï¼ğŸŠ</h1>

                <div class="winners-display" id="winnersDisplay"></div>

                <div class="action-buttons">
                    <button class="btn btn-success" id="exportResults">å¯¼å‡ºç»“æœ</button>
                    <button class="btn btn-secondary" id="restartLottery">é‡æ–°å¼€å§‹</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let participants = [];
        let lotteryConfig = {
            totalRounds: 3,
            allowRepeat: false,
            rounds: []
        };
        let allWinners = [];
        let currentRound = 0;
        let isRolling = false;
        let rollingInterval = null;
        let availableParticipants = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateProgressIndicator(1);
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // ä¸»é¢˜é€‰æ‹©
            document.getElementById('themeSelect').addEventListener('change', function(e) {
                const theme = e.target.value;
                document.body.className = theme !== 'default' ? `theme-${theme}` : '';
            });

            // æ–‡ä»¶ä¸Šä¼ 
            document.getElementById('uploadArea').addEventListener('click', function() {
                document.getElementById('fileInput').click();
            });

            document.getElementById('fileInput').addEventListener('change', handleFileUpload);

            // æ·»åŠ å‚ä¸è€…
            document.getElementById('addBtn').addEventListener('click', addParticipant);
            document.getElementById('newParticipant').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addParticipant();
                }
            });

            // å¯¼èˆªæŒ‰é’®
            document.getElementById('nextToConfig').addEventListener('click', () => {
                showPage(2);
                generateRoundConfig();
            });

            document.getElementById('backToList').addEventListener('click', () => showPage(1));

            document.getElementById('startLottery').addEventListener('click', () => {
                saveLotteryConfig();
                initializeLottery();
                showPage(3);
            });

            // æŠ½å¥–æŒ‰é’®
            document.getElementById('lotteryBtn').addEventListener('click', toggleLottery);

            // ç»“æœé¡µé¢æŒ‰é’®
            document.getElementById('exportResults').addEventListener('click', exportResults);
            document.getElementById('restartLottery').addEventListener('click', restartLottery);

            // æŠ½å¥–è½®æ•°å˜åŒ–
            document.getElementById('totalRounds').addEventListener('change', generateRoundConfig);
        }

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    // æå–ç¬¬ä¸€åˆ—çš„æ‰€æœ‰åå­—
                    const names = jsonData
                        .map(row => row[0])
                        .filter(name => name && String(name).trim() !== '');

                    if (names.length === 0) {
                        alert('Excel æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„åå­—ï¼');
                        return;
                    }

                    if (names.length > 500) {
                        alert('å‚ä¸è€…äººæ•°è¶…è¿‡ 500 äººé™åˆ¶ï¼');
                        return;
                    }

                    // æ·»åŠ åˆ°å‚ä¸è€…åˆ—è¡¨
                    names.forEach(name => {
                        const trimmedName = String(name).trim();
                        if (trimmedName && !participants.includes(trimmedName)) {
                            participants.push(trimmedName);
                        }
                    });

                    updateParticipantList();
                    alert(`æˆåŠŸå¯¼å…¥ ${names.length} ä¸ªå‚ä¸è€…ï¼`);
                } catch (error) {
                    alert('è¯»å– Excel æ–‡ä»¶å¤±è´¥ï¼š' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // æ·»åŠ å‚ä¸è€…
        function addParticipant() {
            const input = document.getElementById('newParticipant');
            const name = input.value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥å§“åï¼');
                return;
            }

            if (participants.length >= 500) {
                alert('å‚ä¸è€…äººæ•°å·²è¾¾ä¸Šé™ï¼ˆ500äººï¼‰ï¼');
                return;
            }

            participants.push(name);
            input.value = '';
            updateParticipantList();
        }

        // æ›´æ–°å‚ä¸è€…åˆ—è¡¨
        function updateParticipantList() {
            const listDiv = document.getElementById('participantList');
            const duplicates = findDuplicates();

            listDiv.innerHTML = '';

            participants.forEach((name, index) => {
                const item = document.createElement('div');
                item.className = 'participant-item';

                if (duplicates[name] && duplicates[name] > 1) {
                    item.classList.add('duplicate');
                }

                item.innerHTML = `
                    <span class="participant-name">
                        ${name}
                        ${duplicates[name] > 1 ? '<span class="warning-badge">é‡å Ã—' + duplicates[name] + '</span>' : ''}
                    </span>
                    <div class="participant-actions">
                        <button class="btn btn-secondary" onclick="editParticipant(${index})">ä¿®æ”¹</button>
                        <button class="btn btn-danger" onclick="deleteParticipant(${index})">åˆ é™¤</button>
                    </div>
                `;

                listDiv.appendChild(item);
            });

            // æ›´æ–°ç»Ÿè®¡
            document.getElementById('totalCount').textContent = participants.length;
            document.getElementById('duplicateCount').textContent = Object.values(duplicates).filter(count => count > 1).length;

            // å¯ç”¨/ç¦ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
            document.getElementById('nextToConfig').disabled = participants.length === 0;
        }

        // æŸ¥æ‰¾é‡å
        function findDuplicates() {
            const counts = {};
            participants.forEach(name => {
                counts[name] = (counts[name] || 0) + 1;
            });
            return counts;
        }

        // ç¼–è¾‘å‚ä¸è€…
        function editParticipant(index) {
            const newName = prompt('ä¿®æ”¹å§“åï¼š', participants[index]);
            if (newName && newName.trim()) {
                participants[index] = newName.trim();
                updateParticipantList();
            }
        }

        // åˆ é™¤å‚ä¸è€…
        function deleteParticipant(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤ "' + participants[index] + '" å—ï¼Ÿ')) {
                participants.splice(index, 1);
                updateParticipantList();
            }
        }

        // ç”ŸæˆæŠ½å¥–è½®æ¬¡é…ç½®
        function generateRoundConfig() {
            const totalRounds = parseInt(document.getElementById('totalRounds').value) || 1;
            const container = document.getElementById('roundsConfig');
            container.innerHTML = '';

            for (let i = 0; i < totalRounds; i++) {
                const roundDiv = document.createElement('div');
                roundDiv.className = 'round-config';
                roundDiv.innerHTML = `
                    <div class="round-header">
                        <h4>ç¬¬ ${i + 1} è½®</h4>
                    </div>
                    <div class="form-group">
                        <label>å¥–é¡¹åç§°ï¼š</label>
                        <input type="text" class="prize-name" value="ç¬¬${i + 1}è½®å¥–é¡¹">
                    </div>
                    <div class="form-group">
                        <label>è·å¥–äººæ•°ï¼š</label>
                        <input type="number" class="prize-count" min="1" value="1">
                    </div>
                `;
                container.appendChild(roundDiv);
            }
        }

        // ä¿å­˜æŠ½å¥–é…ç½®
        function saveLotteryConfig() {
            lotteryConfig.totalRounds = parseInt(document.getElementById('totalRounds').value);
            lotteryConfig.allowRepeat = document.getElementById('allowRepeat').checked;
            lotteryConfig.rounds = [];

            const rounds = document.querySelectorAll('.round-config');
            rounds.forEach((round, index) => {
                const name = round.querySelector('.prize-name').value;
                const count = parseInt(round.querySelector('.prize-count').value);
                lotteryConfig.rounds.push({ name, count });
            });
        }

        // åˆå§‹åŒ–æŠ½å¥–
        function initializeLottery() {
            currentRound = 0;
            allWinners = [];
            availableParticipants = [...participants];
            updateLotteryDisplay();
        }

        // æ›´æ–°æŠ½å¥–æ˜¾ç¤º
        function updateLotteryDisplay() {
            const round = lotteryConfig.rounds[currentRound];
            document.getElementById('currentRoundTitle').textContent = `ç¬¬ ${currentRound + 1} è½®æŠ½å¥–`;
            document.getElementById('currentPrizeName').textContent = round.name;
            document.getElementById('currentPrizeCount').textContent = round.count;
            document.getElementById('lotteryBtn').textContent = 'å¼€å§‹';
            document.getElementById('rollingNames').innerHTML = '<div>å‡†å¤‡å¼€å§‹...</div>';
        }

        // åˆ‡æ¢æŠ½å¥–çŠ¶æ€
        function toggleLottery() {
            if (isRolling) {
                stopLottery();
            } else {
                startLottery();
            }
        }

        // å¼€å§‹æŠ½å¥–
        function startLottery() {
            const round = lotteryConfig.rounds[currentRound];

            if (availableParticipants.length < round.count) {
                alert('å¯ç”¨å‚ä¸è€…äººæ•°ä¸è¶³ï¼');
                return;
            }

            isRolling = true;
            document.getElementById('lotteryBtn').textContent = 'åœæ­¢';
            document.getElementById('lotteryBtn').classList.add('active');

            // å¼€å§‹æ»šåŠ¨åŠ¨ç”»
            rollingInterval = setInterval(() => {
                const displayDiv = document.getElementById('rollingNames');
                displayDiv.innerHTML = '';

                // éšæœºæ˜¾ç¤ºåå­—
                for (let i = 0; i < round.count; i++) {
                    const randomIndex = Math.floor(Math.random() * availableParticipants.length);
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'rolling-name';
                    nameDiv.textContent = availableParticipants[randomIndex];
                    displayDiv.appendChild(nameDiv);
                }
            }, 100);

            // è®¾ç½®æœ€çŸ­æ—¶é—´ï¼ˆ1ç§’ï¼‰åæ‰èƒ½åœæ­¢
            setTimeout(() => {
                document.getElementById('lotteryBtn').style.pointerEvents = 'auto';
            }, 1000);

            // æœ€é•¿æ—¶é—´ï¼ˆ1åˆ†é’Ÿï¼‰åè‡ªåŠ¨åœæ­¢
            setTimeout(() => {
                if (isRolling) {
                    stopLottery();
                }
            }, 60000);
        }

        // åœæ­¢æŠ½å¥–
        function stopLottery() {
            clearInterval(rollingInterval);
            isRolling = false;

            const round = lotteryConfig.rounds[currentRound];
            const winners = [];

            // éšæœºé€‰æ‹©è·å¥–è€…
            for (let i = 0; i < round.count; i++) {
                if (availableParticipants.length === 0) break;

                const randomIndex = Math.floor(Math.random() * availableParticipants.length);
                const winner = availableParticipants[randomIndex];
                winners.push(winner);

                // å¦‚æœä¸å…è®¸é‡å¤ä¸­å¥–ï¼Œä»å¯ç”¨åˆ—è¡¨ä¸­ç§»é™¤
                if (!lotteryConfig.allowRepeat) {
                    availableParticipants.splice(randomIndex, 1);
                }
            }

            // æ˜¾ç¤ºè·å¥–è€…
            const displayDiv = document.getElementById('rollingNames');
            displayDiv.innerHTML = '';
            winners.forEach(winner => {
                const nameDiv = document.createElement('div');
                nameDiv.className = 'rolling-name';
                nameDiv.textContent = winner;
                displayDiv.appendChild(nameDiv);
            });

            // ä¿å­˜è·å¥–è€…
            allWinners.push({
                round: currentRound + 1,
                prizeName: round.name,
                winners: winners
            });

            document.getElementById('lotteryBtn').classList.remove('active');

            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€è½®
            if (currentRound < lotteryConfig.totalRounds - 1) {
                setTimeout(() => {
                    if (confirm('æœ¬è½®æŠ½å¥–å®Œæˆï¼æ˜¯å¦ç»§ç»­ä¸‹ä¸€è½®ï¼Ÿ')) {
                        currentRound++;
                        updateLotteryDisplay();
                    } else {
                        showResults();
                    }
                }, 2000);
            } else {
                setTimeout(() => {
                    alert('æ‰€æœ‰æŠ½å¥–å®Œæˆï¼');
                    showResults();
                }, 2000);
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResults() {
            const container = document.getElementById('winnersDisplay');
            container.innerHTML = '';

            allWinners.forEach(roundResult => {
                const roundDiv = document.createElement('div');
                roundDiv.className = 'round-results';

                let winnersHTML = '';
                roundResult.winners.forEach((winner, index) => {
                    winnersHTML += `<div class="winner-card" style="animation-delay: ${index * 0.1}s">${winner}</div>`;
                });

                roundDiv.innerHTML = `
                    <h3>${roundResult.prizeName}</h3>
                    <div class="winner-grid">
                        ${winnersHTML}
                    </div>
                `;

                container.appendChild(roundDiv);
            });

            showPage(4);
        }

        // å¯¼å‡ºç»“æœ
        function exportResults() {
            let text = 'ğŸ‰ æŠ½å¥–ç»“æœ ğŸ‰\n\n';
            allWinners.forEach(roundResult => {
                text += `${roundResult.prizeName}\n`;
                text += 'è·å¥–è€…ï¼š' + roundResult.winners.join('ã€') + '\n\n';
            });

            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'æŠ½å¥–ç»“æœ.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        // é‡æ–°å¼€å§‹
        function restartLottery() {
            if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿæ‰€æœ‰æ•°æ®å°†è¢«æ¸…ç©ºï¼')) {
                participants = [];
                allWinners = [];
                currentRound = 0;
                updateParticipantList();
                showPage(1);
            }
        }

        // æ˜¾ç¤ºé¡µé¢
        function showPage(pageNumber) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('page' + pageNumber).classList.add('active');
            updateProgressIndicator(pageNumber);
        }

        // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
        function updateProgressIndicator(currentStep) {
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('active', 'completed');

                if (stepNumber === currentStep) {
                    step.classList.add('active');
                } else if (stepNumber < currentStep) {
                    step.classList.add('completed');
                }
            });
        }
    </script>
</body>
</html>
